<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>2048</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      background: #0d1117;
      color: #c9d1d9;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      touch-action: none;
    }
    
    .game-container {
      text-align: center;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      gap: 20px;
    }
    
    .title {
      font-size: 48px;
      font-weight: 800;
      color: #f0883e;
    }
    
    .scores {
      display: flex;
      gap: 10px;
    }
    
    .score-box {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 8px 16px;
      text-align: center;
      min-width: 80px;
    }
    
    .score-label {
      font-size: 11px;
      color: #8b949e;
      text-transform: uppercase;
    }
    
    .score-value {
      font-size: 20px;
      font-weight: 700;
      color: #58a6ff;
    }
    
    .board {
      background: #161b22;
      border-radius: 12px;
      padding: 12px;
      display: grid;
      grid-template-columns: repeat(4, 80px);
      grid-template-rows: repeat(4, 80px);
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .cell {
      background: #21262d;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      font-weight: 700;
      transition: all 0.15s;
    }
    
    .cell[data-value="2"] { background: #3d4450; color: #c9d1d9; }
    .cell[data-value="4"] { background: #4a5568; color: #c9d1d9; }
    .cell[data-value="8"] { background: #f0883e; color: white; }
    .cell[data-value="16"] { background: #e36209; color: white; }
    .cell[data-value="32"] { background: #d73a49; color: white; }
    .cell[data-value="64"] { background: #cb2431; color: white; }
    .cell[data-value="128"] { background: #f9c513; color: #1a1a1a; font-size: 24px; }
    .cell[data-value="256"] { background: #ffd33d; color: #1a1a1a; font-size: 24px; }
    .cell[data-value="512"] { background: #28a745; color: white; font-size: 24px; }
    .cell[data-value="1024"] { background: #22863a; color: white; font-size: 20px; }
    .cell[data-value="2048"] { background: #a371f7; color: white; font-size: 20px; }
    .cell[data-value="4096"] { background: #8957e5; color: white; font-size: 20px; }
    .cell[data-value="8192"] { background: #6f42c1; color: white; font-size: 20px; }
    
    .controls {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-bottom: 16px;
    }
    
    .btn {
      background: #21262d;
      border: 1px solid #30363d;
      color: #c9d1d9;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
    }
    
    .btn:hover {
      background: #30363d;
    }
    
    .btn-primary {
      background: #238636;
      border-color: #238636;
    }
    
    .btn-primary:hover {
      background: #2ea043;
    }
    
    .instructions {
      font-size: 12px;
      color: #6e7681;
    }
    
    .game-over {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(13, 17, 23, 0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }
    
    .game-over.show {
      display: flex;
    }
    
    .game-over-content {
      background: #161b22;
      border: 2px solid #30363d;
      border-radius: 16px;
      padding: 40px;
      text-align: center;
    }
    
    .game-over-title {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 10px;
    }
    
    .game-over-title.win {
      color: #3fb950;
    }
    
    .game-over-title.lose {
      color: #f85149;
    }
    
    .game-over-score {
      font-size: 18px;
      color: #8b949e;
      margin-bottom: 24px;
    }
    
    /* Mobile touch hint */
    @media (max-width: 400px) {
      .board {
        grid-template-columns: repeat(4, 65px);
        grid-template-rows: repeat(4, 65px);
        gap: 8px;
      }
      .cell { font-size: 22px; }
      .title { font-size: 36px; }
    }
  </style>
</head>
<body>
  <div class="game-container">
    <div class="header">
      <div class="title">2048</div>
      <div class="scores">
        <div class="score-box">
          <div class="score-label">Score</div>
          <div class="score-value" id="score">0</div>
        </div>
        <div class="score-box">
          <div class="score-label">Best</div>
          <div class="score-value" id="best">0</div>
        </div>
      </div>
    </div>
    
    <div class="board" id="board"></div>
    
    <div class="controls">
      <button class="btn btn-primary" onclick="newGame()">New Game</button>
      <button class="btn" onclick="undoMove()">Undo</button>
    </div>
    
    <div class="instructions">
      Arrow keys or swipe to play
    </div>
  </div>
  
  <div class="game-over" id="game-over">
    <div class="game-over-content">
      <div class="game-over-title" id="game-over-title">Game Over!</div>
      <div class="game-over-score" id="game-over-score">Score: 0</div>
      <button class="btn btn-primary" onclick="newGame()">Play Again</button>
    </div>
  </div>
  
  <script src="https://clawdos.space/sdk/clawd-miniapp-sdk.js"></script>
  <script>
    if (window.clawd) {
      clawd.ready();
      clawd.setTitle('2048');
    }
    
    const boardEl = document.getElementById('board');
    const scoreEl = document.getElementById('score');
    const bestEl = document.getElementById('best');
    const gameOverEl = document.getElementById('game-over');
    const gameOverTitle = document.getElementById('game-over-title');
    const gameOverScore = document.getElementById('game-over-score');
    
    let board = [];
    let score = 0;
    let best = parseInt(localStorage.getItem('2048-best') || '0');
    let previousState = null;
    let gameEnded = false;
    
    bestEl.textContent = best;
    
    function createBoard() {
      board = Array(4).fill(null).map(() => Array(4).fill(0));
      boardEl.innerHTML = '';
      for (let i = 0; i < 16; i++) {
        const cell = document.createElement('div');
        cell.className = 'cell';
        boardEl.appendChild(cell);
      }
    }
    
    function renderBoard() {
      const cells = boardEl.querySelectorAll('.cell');
      for (let i = 0; i < 4; i++) {
        for (let j = 0; j < 4; j++) {
          const val = board[i][j];
          const cell = cells[i * 4 + j];
          cell.textContent = val || '';
          cell.dataset.value = val || '';
        }
      }
      scoreEl.textContent = score;
      if (score > best) {
        best = score;
        bestEl.textContent = best;
        localStorage.setItem('2048-best', best);
      }
    }
    
    function addRandomTile() {
      const empty = [];
      for (let i = 0; i < 4; i++) {
        for (let j = 0; j < 4; j++) {
          if (board[i][j] === 0) empty.push([i, j]);
        }
      }
      if (empty.length === 0) return false;
      const [r, c] = empty[Math.floor(Math.random() * empty.length)];
      board[r][c] = Math.random() < 0.9 ? 2 : 4;
      return true;
    }
    
    function saveState() {
      previousState = {
        board: board.map(row => [...row]),
        score: score
      };
    }
    
    function undoMove() {
      if (previousState) {
        board = previousState.board.map(row => [...row]);
        score = previousState.score;
        gameEnded = false;
        gameOverEl.classList.remove('show');
        renderBoard();
      }
    }
    
    function slide(row) {
      let arr = row.filter(x => x !== 0);
      for (let i = 0; i < arr.length - 1; i++) {
        if (arr[i] === arr[i + 1]) {
          arr[i] *= 2;
          score += arr[i];
          arr.splice(i + 1, 1);
        }
      }
      while (arr.length < 4) arr.push(0);
      return arr;
    }
    
    function move(dir) {
      if (gameEnded) return;
      
      saveState();
      let moved = false;
      const oldBoard = board.map(r => [...r]);
      
      if (dir === 'left') {
        for (let i = 0; i < 4; i++) {
          board[i] = slide(board[i]);
        }
      } else if (dir === 'right') {
        for (let i = 0; i < 4; i++) {
          board[i] = slide(board[i].reverse()).reverse();
        }
      } else if (dir === 'up') {
        for (let j = 0; j < 4; j++) {
          let col = [board[0][j], board[1][j], board[2][j], board[3][j]];
          col = slide(col);
          for (let i = 0; i < 4; i++) board[i][j] = col[i];
        }
      } else if (dir === 'down') {
        for (let j = 0; j < 4; j++) {
          let col = [board[0][j], board[1][j], board[2][j], board[3][j]];
          col = slide(col.reverse()).reverse();
          for (let i = 0; i < 4; i++) board[i][j] = col[i];
        }
      }
      
      // Check if board changed
      for (let i = 0; i < 4; i++) {
        for (let j = 0; j < 4; j++) {
          if (oldBoard[i][j] !== board[i][j]) moved = true;
        }
      }
      
      if (moved) {
        addRandomTile();
        renderBoard();
        checkGameState();
      }
    }
    
    function checkGameState() {
      // Check for 2048
      for (let i = 0; i < 4; i++) {
        for (let j = 0; j < 4; j++) {
          if (board[i][j] === 2048) {
            gameOverTitle.textContent = 'You Win! ðŸŽ‰';
            gameOverTitle.className = 'game-over-title win';
            gameOverScore.textContent = 'Score: ' + score;
            gameOverEl.classList.add('show');
            gameEnded = true;
            if (window.clawd) clawd.showToast('You reached 2048!');
            return;
          }
        }
      }
      
      // Check for game over
      let hasEmpty = false;
      let hasMerge = false;
      
      for (let i = 0; i < 4; i++) {
        for (let j = 0; j < 4; j++) {
          if (board[i][j] === 0) hasEmpty = true;
          if (j < 3 && board[i][j] === board[i][j + 1]) hasMerge = true;
          if (i < 3 && board[i][j] === board[i + 1][j]) hasMerge = true;
        }
      }
      
      if (!hasEmpty && !hasMerge) {
        gameOverTitle.textContent = 'Game Over!';
        gameOverTitle.className = 'game-over-title lose';
        gameOverScore.textContent = 'Score: ' + score;
        gameOverEl.classList.add('show');
        gameEnded = true;
      }
    }
    
    function newGame() {
      createBoard();
      score = 0;
      gameEnded = false;
      previousState = null;
      gameOverEl.classList.remove('show');
      addRandomTile();
      addRandomTile();
      renderBoard();
    }
    
    // Keyboard
    document.addEventListener('keydown', (e) => {
      if (['ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'].includes(e.key)) {
        e.preventDefault();
        const dir = e.key.replace('Arrow', '').toLowerCase();
        move(dir);
      }
    });
    
    // Touch
    let touchStartX, touchStartY;
    
    document.addEventListener('touchstart', (e) => {
      touchStartX = e.touches[0].clientX;
      touchStartY = e.touches[0].clientY;
    });
    
    document.addEventListener('touchend', (e) => {
      if (!touchStartX || !touchStartY) return;
      
      const dx = e.changedTouches[0].clientX - touchStartX;
      const dy = e.changedTouches[0].clientY - touchStartY;
      const absDx = Math.abs(dx);
      const absDy = Math.abs(dy);
      
      if (Math.max(absDx, absDy) > 30) {
        if (absDx > absDy) {
          move(dx > 0 ? 'right' : 'left');
        } else {
          move(dy > 0 ? 'down' : 'up');
        }
      }
      
      touchStartX = null;
      touchStartY = null;
    });
    
    newGame();
  </script>
</body>
</html>
